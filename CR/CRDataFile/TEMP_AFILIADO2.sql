/* Especifique una o varias sentencias de SQL separadas por signos de punto y coma */
/* DROP TABLE QTEMP.TEMP_AFILIADO ; */
CREATE TABLE QTEMP.TEMP_AFILIADO (
	IDROW INTEGER GENERATED BY DEFAULT AS IDENTITY ( 
	START WITH 1 INCREMENT BY 1 
	NO MINVALUE NO MAXVALUE 
	CYCLE NO ORDER 
	CACHE 20 ) ,
	CODAFILIADO FOR COLUMN CODAF00001 VARCHAR(12) CCSID 284 NOT NULL DEFAULT '' , 
	TIPOAFILIADO FOR COLUMN TIPOA00001 CHAR(1) CCSID 284 NOT NULL DEFAULT '' , 
	NOMBRE VARCHAR(60) CCSID 284 NOT NULL DEFAULT '' , 
	APELLIDO VARCHAR(50) CCSID 284 DEFAULT NULL , 
	NUMTIENDA SMALLINT NOT NULL DEFAULT 0 , 
	NUMFICHA VARCHAR(8) CCSID 284 DEFAULT NULL , 
	CODDEPARTAMENTO FOR COLUMN CODDE00001 CHAR(2) CCSID 284 DEFAULT NULL , 
	CODCARGO VARCHAR(4) CCSID 284 DEFAULT NULL , 
	NITCLIENTE VARCHAR(12) CCSID 284 DEFAULT NULL , 
	DIRECCION VARCHAR(250) CCSID 284 NOT NULL DEFAULT '' , 
	DIRECCIONFISCAL FOR COLUMN DIREC00001 VARCHAR(250) CCSID 284 DEFAULT NULL , 
	CODAREA VARCHAR(9) CCSID 284 DEFAULT NULL , 
	NUMTELEFONO FOR COLUMN NUMTE00001 VARCHAR(9) CCSID 284 DEFAULT NULL , 
	FECHAAFILIACION FOR COLUMN FECHA00001 DATE NOT NULL , 
	EXENTOIMPUESTO FOR COLUMN EXENT00001 CHAR(1) CCSID 284 NOT NULL DEFAULT 'N' , 
	REGISTRADO CHAR(1) CCSID 284 NOT NULL DEFAULT 'N' , 
	CONTACTAR CHAR(1) CCSID 284 NOT NULL DEFAULT 'N' , 
	CODREGION CHAR(3) CCSID 284 NOT NULL DEFAULT '000' , 
	ESTADOAFILIADO FOR COLUMN ESTAD00001 CHAR(1) CCSID 284 NOT NULL DEFAULT 'A' , 
	ESTADOCOLABORADOR FOR COLUMN ESTAD00002 CHAR(1) CCSID 284 NOT NULL DEFAULT 'A' , 
	ACTUALIZACION FOR COLUMN ACTUA00001 TIMESTAMP NOT NULL ) ; 

	-- ACTUALIZACION NECESARIA SI HAY HORACT INVALIDOS ;
	UPDATE MERCADEO.CABAFILIA SET HORACT = '00.00.00' WHERE SUBSTRING(HORACT, 1,1) NOT IN ('0', '1' , '2');
	UPDATE MERCADEO.CABAFILIA SET FECAFI = '1980-01-01' WHERE FECAFI < '1980-01-01';
	-- DEBIDO A VALORES DE TIENMCNA QUE NO SON TRANSFORMABLES A NUMEROS, SE HA VISTO LA NECESIDAD DE EJECUTAR ESTA CONSULTA;
	UPDATE MERCADEO.MAEMCNA SET TIENMCNA = '001' WHERE SUBSTRING(TIENMCNA, 1,1) NOT IN ('0', '1' , '2');
	UPDATE MERCADEO.MAEMCNA SET FECHMCNA = SUBSTRING(TRIM(CHAR(CURRENT_DATE, ISO)), 1, 4) || SUBSTRING(TRIM(CHAR(CURRENT_DATE, ISO)), 6, 2) || SUBSTRING(TRIM(CHAR(CURRENT_DATE, ISO)), 9, 2) WHERE SUBSTRING(FECHMCNA, 1,1) NOT IN ('1' , '2'); 
	UPDATE MERCADEO.MAEMCNA SET FECAMCNA = FECHMCNA WHERE SUBSTRING(FECAMCNA, 1,1) NOT IN ('1' , '2');

INSERT INTO QTEMP.TEMP_AFILIADO (CODAFILIADO, TIPOAFILIADO, NOMBRE, APELLIDO, NUMTIENDA, NUMFICHA, CODDEPARTAMENTO, CODCARGO, NITCLIENTE, DIRECCION, DIRECCIONFISCAL, CODAREA, NUMTELEFONO, FECHAAFILIACION, EXENTOIMPUESTO, REGISTRADO, CONTACTAR, CODREGION, ESTADOAFILIADO, ESTADOCOLABORADOR, ACTUALIZACION) 
 SELECT VISTA.CODAFILIADO, VISTA.TIPOAFILIADO, VISTA.NOMBRE, VISTA.APELLIDO, VISTA.NUMTIENDA, VISTA.NUMFICHA, VISTA.CODDEPARTAMENTO, VISTA.CODCARGO, VISTA.NITCLIENTE, VISTA.DIRECCION, VISTA.DIRECCIONFISCAL, VISTA.CODAREA, VISTA.NUMTELEFONO, VISTA.FECHAAFILIACION, VISTA.EXENTOIMPUESTO, VISTA.REGISTRADO, VISTA.CONTACTAR, VISTA.CODREGION, VISTA.ESTADOAFILIADO, VISTA.ESTADOCOLABORADOR, VISTA.ACTUALIZACION 
	FROM CR.MAEPDBC_2_AFILIADO VISTA
 EXCEPTION JOIN QTEMP.TEMP_AFILIADO AFIL ON (AFIL.CODAFILIADO = VISTA.CODAFILIADO)
	WHERE VISTA.ESTADOCOLABORADOR = 'A' 
		AND AFIL.CODAFILIADO IS NULL 
	
;

INSERT INTO QTEMP.TEMP_AFILIADO (CODAFILIADO, TIPOAFILIADO, NOMBRE, APELLIDO, NUMTIENDA, NUMFICHA, CODDEPARTAMENTO, CODCARGO, NITCLIENTE, DIRECCION, DIRECCIONFISCAL, CODAREA, NUMTELEFONO, FECHAAFILIACION, EXENTOIMPUESTO, REGISTRADO, CONTACTAR, CODREGION, ESTADOAFILIADO, ESTADOCOLABORADOR, ACTUALIZACION) 
 SELECT VISTA.CODAFILIADO, VISTA.TIPOAFILIADO, VISTA.NOMBRE, VISTA.APELLIDO, VISTA.NUMTIENDA, VISTA.NUMFICHA, VISTA.CODDEPARTAMENTO, VISTA.CODCARGO, VISTA.NITCLIENTE, VISTA.DIRECCION, VISTA.DIRECCIONFISCAL, VISTA.CODAREA, VISTA.NUMTELEFONO, VISTA.FECHAAFILIACION, VISTA.EXENTOIMPUESTO, VISTA.REGISTRADO, VISTA.CONTACTAR, VISTA.CODREGION, VISTA.ESTADOAFILIADO, VISTA.ESTADOCOLABORADOR, VISTA.ACTUALIZACION 
	FROM CR.CABAFILIA_2_AFILIADO VISTA 
 EXCEPTION JOIN QTEMP.TEMP_AFILIADO AFIL ON (AFIL.CODAFILIADO = VISTA.CODAFILIADO)
	WHERE AFIL.CODAFILIADO IS NULL 
;

INSERT INTO QTEMP.TEMP_AFILIADO (CODAFILIADO, TIPOAFILIADO, NOMBRE, APELLIDO, NUMTIENDA, NUMFICHA, CODDEPARTAMENTO, CODCARGO, NITCLIENTE, DIRECCION, DIRECCIONFISCAL, CODAREA, NUMTELEFONO, FECHAAFILIACION, EXENTOIMPUESTO, REGISTRADO, CONTACTAR, CODREGION, ESTADOAFILIADO, ESTADOCOLABORADOR, ACTUALIZACION) 
 SELECT VISTA.CODAFILIADO, VISTA.TIPOAFILIADO, VISTA.NOMBRE, VISTA.APELLIDO, VISTA.NUMTIENDA, VISTA.NUMFICHA, VISTA.CODDEPARTAMENTO, VISTA.CODCARGO, VISTA.NITCLIENTE, VISTA.DIRECCION, VISTA.DIRECCIONFISCAL, VISTA.CODAREA, VISTA.NUMTELEFONO, VISTA.FECHAAFILIACION, VISTA.EXENTOIMPUESTO, VISTA.REGISTRADO, VISTA.CONTACTAR, VISTA.CODREGION, VISTA.ESTADOAFILIADO, VISTA.ESTADOCOLABORADOR, VISTA.ACTUALIZACION 
	FROM CR.MAEMCNA_2_AFILIADO VISTA 
 EXCEPTION JOIN QTEMP.TEMP_AFILIADO AFIL ON (AFIL.CODAFILIADO = VISTA.CODAFILIADO)
	WHERE AFIL.CODAFILIADO IS NULL 
;

/** INSERTAR LOS COLABORADORES INACTIVOS PARA DESPUES SABER QUIENES SON Y PODER CREAR RUTINAS DE BORRADO */
INSERT INTO QTEMP.TEMP_AFILIADO (CODAFILIADO, TIPOAFILIADO, NOMBRE, APELLIDO, NUMTIENDA, NUMFICHA, CODDEPARTAMENTO, CODCARGO, NITCLIENTE, DIRECCION, DIRECCIONFISCAL, CODAREA, NUMTELEFONO, FECHAAFILIACION, EXENTOIMPUESTO, REGISTRADO, CONTACTAR, CODREGION, ESTADOAFILIADO, ESTADOCOLABORADOR, ACTUALIZACION) 
 SELECT VISTA.CODAFILIADO, VISTA.TIPOAFILIADO, VISTA.NOMBRE, VISTA.APELLIDO, VISTA.NUMTIENDA, VISTA.NUMFICHA, VISTA.CODDEPARTAMENTO, VISTA.CODCARGO, VISTA.NITCLIENTE, VISTA.DIRECCION, VISTA.DIRECCIONFISCAL, VISTA.CODAREA, VISTA.NUMTELEFONO, VISTA.FECHAAFILIACION, VISTA.EXENTOIMPUESTO, VISTA.REGISTRADO, VISTA.CONTACTAR, VISTA.CODREGION, VISTA.ESTADOAFILIADO, VISTA.ESTADOCOLABORADOR, VISTA.ACTUALIZACION 
	FROM CR.MAEPDBC_2_AFILIADO VISTA
 EXCEPTION JOIN QTEMP.TEMP_AFILIADO AFIL ON (AFIL.CODAFILIADO = VISTA.CODAFILIADO)
	WHERE VISTA.ESTADOCOLABORADOR = 'B' 
		AND AFIL.CODAFILIADO IS NULL 
;

UPDATE QTEMP.TEMP_AFILIADO SET ACTUALIZACION = CURRENT_TIMESTAMP WHERE ACTUALIZACION > CURRENT_TIMESTAMP + 1 DAY;